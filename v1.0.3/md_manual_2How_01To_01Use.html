<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NNP STM Bootloader: How To Use</title>
<link rel="icon" href="cosmiic-icon.png" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
        <script type="text/javascript">
            DoxygenAwesomeDarkModeToggle.init()
        </script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
        <script type="text/javascript">
            DoxygenAwesomeInteractiveToc.init()
        </script>
<script type="text/javascript">
  $(function () {
    var repoName = window.location.pathname.split('/')[1];
    $.get('/' + repoName + '/version_selector.html', function (data) {
        // Inject version selector HTML into the page
        $('#projectnumber').html(data);
        // Event listener to handle version selection
        document.getElementById('versionSelector').addEventListener('change', function () {
            var selectedVersion = this.value;
            window.location.href = '/' + repoName + '/' + selectedVersion + '/index.html';
        });
        // Set the selected option based on the current version
        var currentVersion = window.location.pathname.split('/')[2];
        $('#versionSelector').val(currentVersion);
    });
  });
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="cosmiic-icon.png"/></td>
  <td id="projectalign">
   <div id="projectname">NNP STM Bootloader<span id="projectnumber">&#160;v1.0.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_manual_2How_01To_01Use.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">How To Use</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#autotoc_md19">Bootloader Features</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md20">Configuring Bootloader Builds</a>
    <ul>
      <li class="level2">
        <a href="#autotoc_md21">Assigning Serial Number and Module Type</a>
      </li>
    </ul>
  </li>
  <li class="level1">
    <a href="#autotoc_md22">Configuring Application Builds</a>
    <ul>
      <li class="level2">
        <a href="#autotoc_md23">Core/Src/system_stm32l4xx.c (Application)</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md24">STM32L433RCTXP_FLASH.ld (Application)</a>
      </li>
    </ul>
  </li>
  <li class="level1">
    <a href="#autotoc_md25">Using the Bootloader</a>
    <ul>
      <li class="level2">
        <a href="#autotoc_md26">Troubleshooting</a>
      </li>
    </ul>
  </li>
  <li class="level1">
    <a href="#autotoc_md27">Polling Module Information In Application</a>
  </li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="autotoc_md19"></a>
Bootloader Features</h1>
<p>The bootloader allows for:</p><ul>
<li>Starting the programmed application</li>
<li>Programming new applications</li>
<li>Resetting the Object Dictionary</li>
<li>Setting module node number</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>The bootloader does not implement an Object Dictionary, and only responds to specific bootloader commands.</dd></dl>
<h1><a class="anchor" id="autotoc_md20"></a>
Configuring Bootloader Builds</h1>
<p>The bootloader is configured via the <code><a class="el" href="config_8h.html" title="Configures memory spaces and other boot settings.">config.h</a></code> file located within Core/Inc. The only parameter in this file that should be changed is <code>WRP_ENABLE</code>, which enables write protection over the bootloader on first application launch. Prebuilt binaries of the bootloader will have this flag enabled. Modifying other paramters in this file can cause unexpected behavior within applications. Any applications run via the bootloader must have a matching memory configuration (Application Size, Parameter Location, EEPROM Location and Size). The <a href="https://github.com/COSMIIC-Inc/Implantables-GenericModule-Application">Generic Module</a> is compatible with the standard bootloader.</p>
<h2><a class="anchor" id="autotoc_md21"></a>
Assigning Serial Number and Module Type</h2>
<p>The Serial Number and Module Type Idenfitier live in the last three bytes of the assigned bootloader space in flash (Addresses <code>0x08004FFD</code> - <code>0x08004FFF</code>). To prevent unexpected behavior, these parameters should be written to the end of the bootloader <code>.bin</code> image before it gets programmed to the bootloader at address <code>0x08000000</code>.</p>
<p>The following Matlab script can be used to program these parameters.</p>
<details >
<summary >
ST_AssignSN.m</summary>
<div class="fragment"><div class="line">%% Set Parameters</div>
<div class="line">SerialNumber = 1234;</div>
<div class="line">moduleType = 4;</div>
<div class="line"> </div>
<div class="line">%% Get File Handle and Size</div>
<div class="line">[bin, location] = uigetfile(&#39;*.bin&#39;);</div>
<div class="line">fid = fopen([location bin]);</div>
<div class="line">fseek(fid, 0, &#39;eof&#39;);</div>
<div class="line">filesize = ftell(fid);</div>
<div class="line">fclose(fid);</div>
<div class="line">if(filesize&gt;20477)</div>
<div class="line">    error(&quot;File is too large to assign serial number and module type&quot;)</div>
<div class="line">end</div>
<div class="line">%% Get File Data</div>
<div class="line">fid = fopen([location bin]);</div>
<div class="line">dataWrite = zeros(20480, 1);</div>
<div class="line"> </div>
<div class="line">SerialNumberConvert = typecast(uint16(SerialNumber), &#39;uint8&#39;);</div>
<div class="line"> </div>
<div class="line">if(moduleType &gt; 255)</div>
<div class="line">    error(&quot;Invalid moduleType&quot;)</div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">dataGen = fread (fid, filesize);</div>
<div class="line"> </div>
<div class="line">dataWrite(1:filesize) = dataGen;</div>
<div class="line">fclose(fid);</div>
<div class="line"> </div>
<div class="line">%% Write bin data to dataWrite</div>
<div class="line">dataWrite(20478) = SerialNumberConvert(2);</div>
<div class="line">dataWrite(20479) = SerialNumberConvert(1);</div>
<div class="line">dataWrite(20480) = moduleType;</div>
<div class="line"> </div>
<div class="line">%% Write modified bin to disk</div>
<div class="line">bin = [bin(1:end-4) &#39;_SN&#39; num2str(SerialNumber) &#39;.bin&#39;];</div>
<div class="line">fid = fopen([location bin], &#39;w&#39;);</div>
<div class="line">fwrite(fid, dataWrite);</div>
<div class="line"> </div>
<div class="line">fclose(fid);</div>
<div class="line">sprintf(&#39;Write file %s with Serial Number %d and moduleType %d&#39;, bin, SerialNumber, moduleType)</div>
</div><!-- fragment --> </details>
<h1><a class="anchor" id="autotoc_md22"></a>
Configuring Application Builds</h1>
<p>Because the bootloader lives in the first 20K of flash, the flashed application must have changes made to several files in order to ensure correct operation. If you are creating an application based on the <a href="https://github.com/COSMIIC-Inc/Implantables-GenericModule-Application">Generic Module</a>, these changes are already in place.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Core/Src/system_stm32l4xx.c (Application)</h2>
<p>The following changes are made to the <a class="el" href="system__stm32l4xx_8c.html">system_stm32l4xx.c</a> file:</p><ul>
<li><code>#define USER_VECT_TAB_ADDRESS</code> - is defined</li>
<li><code>#define VECT_TAB_OFFSET 0x00005000U</code> - changed from 0x00000000U</li>
</ul>
<h2><a class="anchor" id="autotoc_md24"></a>
STM32L433RCTXP_FLASH.ld (Application)</h2>
<p>This is the linker script that defines the addressing of FLASH, RAM, and other important addresses of the microcontroller.</p>
<p>The only change is made to the <em>Memories definiton</em> section.</p>
<div class="fragment"><div class="line">MEMORY</div>
<div class="line">{</div>
<div class="line">  RAM    (xrw)    : ORIGIN = 0x20000000,   LENGTH = 48K</div>
<div class="line">  RAM2    (xrw)    : ORIGIN = 0x10000000,   LENGTH = 16K</div>
<div class="line">  FLASH    (rx)    : ORIGIN = 0x08005000,   LENGTH = 232K</div>
<div class="line">}</div>
</div><!-- fragment --><p>The flash origin has a 0x5000 offset due to the bootloader, and the length is shortened, due to the bootloader, module parameter storage, and reserved EEPROM space.</p>
<p>For a 256K module:</p><ul>
<li>256K - 20K (bootloader) - 2K (parameter space) - 2K (EEPROM) = 232K</li>
</ul>
<h1><a class="anchor" id="autotoc_md25"></a>
Using the Bootloader</h1>
<p>In Matlab, call <code>rmbootloader(nnp)</code> to open the remote module bootloader program. Clicking 'Scan for Nodes' will probe the network for available nodes.</p>
<div class="image">
<img src="BootMain.png" alt=""/>
<div class="caption">
rmbootloader Main Screen</div></div>
    <div class="image">
<img src="NodeScan.png" alt=""/>
<div class="caption">
Node Polling Modal</div></div>
    <div class="image">
<img src="BootNodeList.png" alt=""/>
<div class="caption">
Node Populated List</div></div>
    <p>Selecting a node in the list and clicking 'Select Node' will select the module in the bootloader and populate node information.</p>
<div class="image">
<img src="BootSelectNodeEBSA.png" alt=""/>
<div class="caption">
Selected Node</div></div>
    <p>From here, you can load a new application, or start the app.</p>
<p>In the <b>Exit Bootloader/Start App</b> section, there are two buttons. The left button 'Selected Node' will only start the application on the currently selected node. The checkbox above it, 'Restore OD Defaults' will reset the Object Dictionary of the selected device before it starts (full erase of the emulated EEPROM) if selected. The 'All Nodes' button will start all nodes on the network, without any changes to their Object Dictionaries.</p>
<p><img src="/manual/images/BootSelectNodeRMF.png" alt="" class="inline"/></p>
<p>The <b>Remote Module Flash</b> section is where you can load a new program onto a module. The checkboxes identify which parts of the programming sequence will take place. To overwrite a new program over an existing one, the flash must erased before a new program can be loaded. The functions of each of the programming sequences are below:</p>
<ul>
<li><b>Erase:</b> Erases the application space of the module</li>
<li><b>BlankCheck:</b> Ensures that the application space is fully blank, if not returns the address of the first non-blank result.</li>
<li><b>Write:</b> Writes the new application to flash</li>
<li><b>Verify:</b> Read back the application flash to ensure all bytes are written correctly, if not, returns the address of the first conflict.</li>
</ul>
<p>Clicking start will open a file select dialog to select a firmware <code>.bin</code> file to upload to the module.</p>
<p>Several progress bars indicating the progress of each stage will appear. If the process completes successfully, a modal similar to that below should appear:</p>
<div class="image">
<img src="FinalUploadScreen.png" alt=""/>
</div>
    <h2><a class="anchor" id="autotoc_md26"></a>
Troubleshooting</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Issue   </th><th class="markdownTableHeadNone">Resolution    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">No network activity   </td><td class="markdownTableBodyNone">- Ensure that all modules connected to the network are properly configured to operate on the network. Floating inputs will cause inoperation of the network.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">The bootloader says "Node is Running Application. Power cycle network to enter bootloader mode"   </td><td class="markdownTableBodyNone">- Node is Running Application. Power cycle network to enter bootloader mode.<br  />
 - If restarting via CLI, use <code>nnp.networkOnBootloader</code>, not <code>nnp.networkOn</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">My module doesn't appear in the network   </td><td class="markdownTableBodyNone">- Ensure network cables are connected correctly (BUSA -&gt; BUSA, BUSB -&gt; BUSB).<br  />
 - Ensure module core is not in a lockup mode.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Blankcheck found non-erased byte after erasing   </td><td class="markdownTableBodyNone">- Attempt to erase the module again.<br  />
 - Restart the network.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Writing to the module randomly fails during upload   </td><td class="markdownTableBodyNone">- Ensure the Power Module has a good radio connection to the access point.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Verify failed   </td><td class="markdownTableBodyNone">- Ensure that the uploaded file matches the file being verified.<br  />
 - Restart the network.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">"Node may not be on the network. Run a scan to see available nodes"   </td><td class="markdownTableBodyNone">- Ensure network cables are connected correctly.<br  />
 - Ensure the Power Module has a good radio connection to the access point.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">"Could not confirm Network Status. Toggle Network button to update."   </td><td class="markdownTableBodyNone">- Toggle network button, if that doesn't work, power cycle the access point and reopen rmbootloader.   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md27"></a>
Polling Module Information In Application</h1>
<p>The bootloader space contains the Serial Number, and Module Type "Identifier" in the last three bytes of its defined space. Their default locations are as follows:</p><ul>
<li>0x08004FFD - Serial Number High Byte</li>
<li>0x08004FFE - Serial Number Low Byte</li>
<li>0x08004FFF - Module Type Identifier</li>
</ul>
<p>Other module parameters are located in the last page of flash memory. (For the STM32L433, these are located at address <code>127*FLASH_PAGE_SIZE</code>). The order of parameters are:</p><ul>
<li>UNS8 - Node Number</li>
<li>UNS8 - App Checksum</li>
<li>UNS24 - App Size</li>
<li>UNS8 - Checksum Clock (Unused)</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>The generic module application will automatically pull information from their locations and assign them in the Object Dictionary </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
